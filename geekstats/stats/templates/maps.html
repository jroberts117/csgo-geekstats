{% extends 'base.html' %}
{% load static %}

{% block title %}{{title}}{% endblock title %}

{% block content %}


<table>
	<tr>
		<th><div class="team {% if tab != 1 %} btnactive {% endif %}" id="btnplays">Map Plays</div></th>
		<th><div class="team {% if tab == 1 %} btnactive {% endif %}" id="btnstats">Map Stats</div></th>
	</tr>
</table>

<div id="mapplays" class="page rowwrap">
	{% if not mapstats %}<P>You must be logged in to see Map Play Data</P>{% endif %}
	{% for i in mapstats %}
	<div class="highlightbox">
		<div class="header">
			<div class="hddata hero">{{i.map|upper}} </div>
			<div class="hddata info"> &nbsp;
				<span title="{{i.rating}}">
					<div class="box"
					{% if i.rating > 1.5 %}
						style="background: #00FF00;"
					{% elif i.rating > 1 %}
						style="background: #71B238;"
					{% elif i.rating > 0.5 %}
						style="background: #A6CB45;"
					{% elif i.rating > 0 %}
						style="background: #FEFCD7;"
					{% elif i.rating > -0.5 %}
						style="background: #F5B79B;"
					{% elif i.rating > -1 %}
						style="background: #F5B79B;"
					{% elif i.rating >= -1.5 %}
						style="background:  #FF5E99;"
					{% elif i.rating < -1.5 %}
						style="background: red;"
					{% else %}
						style="background: gray;"
					{% endif %}
					></div>Rating: &nbsp;
				</span>
			</div>
			<div class="hddata info">CT Win: 
				{% if i.ct_win_pct > 60 or i.ct_win_pct < 40 %} <span style="font-weight: 400; color: red;"> {% else %} <span style="font-weight: 400; color: green;"> {% endif %}
					{{i.ct_win_pct|floatformat:1}}% </span> [{{i.plays}} {% if i.plays > 1 %} plays {% else %} play {% endif %}]</div>
		</div>
        <!-- {% for j in playdata %}
            {% if i.map == j.match_id__map %}
                 {% if j.win_side == 'CT' %}
                     CT Wins: {{j.num_plays}}
                 {% else %}
                     T Wins = {{j.num_plays}}
				{% endif %}
			{% endif %}
		{% endfor %} -->

			<table class="" style="background: linear-gradient(rgba(191,191,191,0.5),rgba(191,191,191,0.5)),url('/static/images/{{i.map}}.jpg');
										background-repeat: no-repeat;background-size: cover;">
				<tr class="black">
					<td>Player</td>
					<td>KDR</td>
				</tr>
				{% for j in i.player_info.values|dictsortreversed:'kdr' %}				
				{% if user.get_username|upper == j.player|upper %}
					<tr class="curr_user">
				{% else %}
					<tr>
				{% endif %}
						<td><a href="PlayerDetails?pid={{j.id}}">{{j.player}}</a></td>
						<td><a href="Details?pid={{j.id}}&mid={{i.map}}">{{j.kdr|floatformat:2}}</a></td>	
					</tr>
				{% endfor %}
			</table>
		</div>

	{% endfor %}

</div>
<div id="mapstats"  class="page rowwrap" style="display: none; width:100%;">
	<div style="text-align:center; padding-top: 15px;">
		<input id="myMap" onkeyup="myFunction()" type="text" name="map" placeholder="map name" title="Type in a name">
	</div>
	
	
	
	<table id="myTable" class="section_center zebra js-sort-table">
		<tr class="black">
			<th class="js-sort-number">GeekScore</th>
			<th class="js-sort-text">Map</th>
			{% if user.is_authenticated %}
				<th class="js-sort-text">Your Rating</th>
			{% endif %}
			<th class="js-sort-text">Plays</th>
			<th class="js-sort-text">Seasons</th>
			<th class="js-sort-number">CT Win %</th>
			<th>Type</th>
			<th>Theme</th>
			<th>Top Geek</th>
			<th>Top Gun</th>
			<th class="js-sort-number">Last Play (days)</th>
		</tr>
	
		{% for i in maps %}
		<tr>
			<td class="text_center">
				<div class="hddata info"> &nbsp;
					<div class="box"
					{% if i.metascore > 75 %}
						style="background: #6c3;"
					{% elif i.metascore > 50 %}
						style="background: #Fc3;"
					{% elif i.metascore > -1 %}
						style="background: #f00;"
					{% else %}
						style="background: gray;"
					{% endif %}
					>{{i.metascore}}</div>
				</div>
			</td>
			<td>
				<div class="hover_img">
					<a href="#">{{ i.name }}<span><img src="{% static 'images/'%}{{i.name}}.jpg" alt="no image on server" height="400" /></span></a>
					{% if i.ninja_pct > 2 %} <span title="{{ i.ninja_pct }}% of kills including: {{i.tazes}} tazes, {{i.flames}} flames, {{i.grenades}} grenades, and {{i.knives}} stabs"><img src="{% static 'images/ninja_icon1'%}.png" height="20" align="center"> </span>{% endif %}
					{% if i.snipe_pct > 10 %} <span title="{{i.snipe_pct}}% of kills were from snipers"><img src="{% static 'images/sniper'%}.png" height="25" align="center"></span>{% endif %}
					{% if i.hmg_pct > 10 %} <span title="{{i.hmg_pct}}% of kills were from HMG mow downs"><img src="{% static 'images/hmg3'%}.png" height="25" align="center"></span>  {% endif %}
			   </div>
			</td>
			{% if user.is_authenticated %}
				<td>
					<ul class="list-inline rating-list" style="background-color: transparent; border-right:none;">
						<li style="border-right: none;" onclick="ratingUpdate({{i.id}},{{userid}}, 5)"><i id="star5-{{i.id}}" class="fa fa-star {% if i.geek_rating > 4 %}checked{% endif %}" title="Greatest map EVER!!!"></i></li>
						<li style="border-right: none;" onclick="ratingUpdate({{i.id}},{{userid}}, 4)"><i id="star4-{{i.id}}" class="fa fa-star {% if i.geek_rating > 3 %}checked{% endif %}" title="I like it!"></i></li>
						<li style="border-right: none;" onclick="ratingUpdate({{i.id}},{{userid}}, 3)"><i id="star3-{{i.id}}" class="fa fa-star {% if i.geek_rating > 2 %}checked{% endif %}" title="It's playable"></i></li>
						<li style="border-right: none;" onclick="ratingUpdate({{i.id}},{{userid}}, 2)"><i id="star2-{{i.id}}" class="fa fa-star {% if i.geek_rating > 1 %}checked{% endif %}" title="meh"></i></li>
						<li style="border-right: none;" onclick="ratingUpdate({{i.id}},{{userid}}, 1)"><i id="star1-{{i.id}}" class="fa fa-star {% if i.geek_rating > 0 %}checked{% endif %}" title="Pure rubbish"></i></li>
					</ul>
					<!-- <span class="fa fa-star checked"></span>
					<span class="fa fa-star checked"></span>
					<span class="fa fa-star checked"></span>
					<span class="fa fa-star highlighted"></span>
					<span class="fa fa-star"></span> -->
				</td>
			{% endif %}
			<td class="text_center">{{ i.plays }}</td>
			<td class="text_center">{{ i.s_plays }}</td>
			<td class="text_center">
				<div class="hddata info">
					{% if i.balance > 60 or i.balance < 40 %} <span style="font-weight: 400; color: red;"> {% else %} <span style="font-weight: 400; color: green;"> {% endif %}
						{{i.balance|floatformat:1}}% </span> 
				</div>
			</td>
			<td class="text_center">{{ i.type }}</td>
			<td class="text_center">{{ i.theme }}</td>
			<td class="text_center">{% with i.players|last as last %} {{ last.item }} {%endwith%}</td>
			<td class="text_center">{% with i.weapons|last as last %} <span title="{{last.count}} kills with a {{last.item}}"><img src="{% static 'images/'%}{{ last.item }}.png" align="center"></span>{%endwith%}</td>
			<td class="text_center">{% if i.last_play %}{{i.last_play}}{%else%}9999{%endif%}</td>
		</tr>
		{% endfor %}
	
	</table>
	
	<script>
		function myFunction() {
		  var input, filter, table, tr, td, i, txtValue;
		  input = document.getElementById("myMap");
		  filter = input.value.toUpperCase();
		  table = document.getElementById("myTable");
		  tr = table.getElementsByTagName("tr");
		  for (i = 0; i < tr.length; i++) {
			td = tr[i].getElementsByTagName("td")[1];
			if (td) {
			  txtValue = td.textContent || td.innerText;
			  if (txtValue.toUpperCase().indexOf(filter) > -1) {
				tr[i].style.display = "";
			  } else {
				tr[i].style.display = "none";
			  }
			}       
		  }
		}

		function ratingUpdate(map, geek, rating) {

			var form = new FormData();
			form.append("map_id", map);
			form.append("user_id", geek);
			form.append("rating", rating);

			var settings = {
			"url": "http://test.geekfest.live:8000/api/stats/rating/",
			"method": "POST",
			"timeout": 0,
			"headers": {
				"Cookie": "sessionid=fkcrfqey2igzl8m9alg6qlsihcd0n89j"
			},
			"processData": false,
			"mimeType": "multipart/form-data",
			"contentType": false,
			"data": form
			};

			$.ajax(settings).done(function (response) {
			console.log(response);
			});

			var ele5 = 'star5-' + map, ele4 = 'star4-' + map, ele3 = 'star3-' + map, ele2 = 'star2-' + map, ele1 = 'star1-' + map;
			document.getElementById(ele5).classList.remove('checked');
			document.getElementById(ele4).classList.remove('checked');
			document.getElementById(ele3).classList.remove('checked');
			document.getElementById(ele2).classList.remove('checked');
			document.getElementById(ele1).classList.remove('checked');

			if (rating>4) {
				document.getElementById(ele5).classList.add('checked');
			} 
			if (rating>3) {
				document.getElementById(ele4).classList.add('checked');
			} 
			if (rating>2) {
				document.getElementById(ele3).classList.add('checked');
			} 
			if (rating>1) {
				document.getElementById(ele2).classList.add('checked');
			} 
			if (rating>0) {
				document.getElementById(ele1).classList.add('checked');
			} 
		}
		</script>
</div>

<script type="text/JavaScript">
	document.getElementById("btnplays").onclick = function() {
		document.getElementById("mapplays").style['display'] = "flex";
		document.getElementById("dateselector").style['display'] = "inline-block";
		document.getElementById("mapstats").style['display'] = "none";
		document.getElementById("btnplays").classList.toggle("btnactive");
		document.getElementById("btnstats").classList.toggle("btnactive");
	};

	document.getElementById("btnstats").onclick = function() {
		document.getElementById("mapstats").style['display'] = "inline-block";
		document.getElementById("mapplays").style['display'] = "none";
		document.getElementById("dateselector").style['display'] = "none";
		document.getElementById("btnplays").classList.toggle("btnactive");
		document.getElementById("btnstats").classList.toggle("btnactive");
	};

</script>
{% endblock content %}
